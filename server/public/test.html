<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VAPI æµ‹è¯•é¡µé¢</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 800px; margin: 20px auto; padding: 0 20px; }
    #log { background: #1e1e1e; color: #0f0; padding: 15px; height: 400px; overflow-y: auto; font-family: monospace; font-size: 13px; border-radius: 8px; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    .connected { background: #4CAF50; color: white; }
    .disconnected { background: #f44336; color: white; }
    input { padding: 10px; width: 300px; margin: 5px; }
  </style>
</head>
<body>
  <h1>ğŸ¤ VAPI å®æ—¶è¯­éŸ³æµ‹è¯•</h1>

  <div>
    <input type="text" id="wsUrl" value="ws://localhost:3000/ws/conversations/test-123?assistant_id=default" placeholder="WebSocket URL">
  </div>

  <div>
    <button id="connectBtn" onclick="connect()">è¿æ¥</button>
    <button onclick="sendText()">å‘é€æ–‡æœ¬</button>
    <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
  </div>

  <div>
    <input type="text" id="textInput" placeholder="è¾“å…¥æ–‡æœ¬æ¶ˆæ¯" onkeypress="if(event.key==='Enter')sendText()">
  </div>

  <h3>æ—¥å¿—</h3>
  <div id="log"></div>

  <script>
    let ws = null;

    function log(msg, type = 'info') {
      const logDiv = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      const colors = { info: '#0f0', error: '#f44336', sent: '#ff0', received: '#0ff' };
      logDiv.innerHTML += `<div style="color: ${colors[type] || '#0f0'}">[${time}] ${msg}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    function connect() {
      const url = document.getElementById('wsUrl').value;
      const btn = document.getElementById('connectBtn');

      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.close();
        return;
      }

      log(`æ­£åœ¨è¿æ¥: ${url}`, 'sent');

      ws = new WebSocket(url);

      ws.onopen = () => {
        log('âœ… WebSocket å·²è¿æ¥', 'received');
        btn.textContent = 'æ–­å¼€';
        btn.className = 'connected';
      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          log(`ğŸ“¥ ${data.type}: ${JSON.stringify(data.data).substring(0, 100)}`, 'received');
        } catch (e) {
          log(`ğŸ“¥ ${event.data}`, 'received');
        }
      };

      ws.onerror = (error) => {
        log('âŒ WebSocket é”™è¯¯', 'error');
      };

      ws.onclose = () => {
        log('ğŸ”Œ WebSocket å·²æ–­å¼€', 'info');
        btn.textContent = 'è¿æ¥';
        btn.className = 'disconnected';
      };
    }

    function sendText() {
      const input = document.getElementById('textInput');
      const text = input.value.trim();

      if (!text) return;
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('âŒ æœªè¿æ¥', 'error');
        return;
      }

      const message = {
        type: 'text',
        data: { content: text }
      };

      ws.send(JSON.stringify(message));
      log(`ğŸ“¤ å‘é€: ${text}`, 'sent');
      input.value = '';
    }
  </script>
</body>
</html>
